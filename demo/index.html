<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Eyevinn Open Analytics</title>
  <script type="module" src="demo.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@exampledev/new.css@1/new.min.css" />
  <link rel="stylesheet" href="https://fonts.xz.style/serve/inter.css" />
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <header>
    <picture>
      <source srcset="./logo-darkmode.png" media="(prefers-color-scheme: dark)">
      <img src="./logo-lightmode.png" />
    </picture>
    <h1>Open Analytics</h1>
  </header>

  <div id="wrapper">
    <div id="controls">
      <input
        id="videoUrlInput"
        type="text"
        value="https://archive.org/serve/big-bunny-sample-video/SampleVideo.ia.mp4"
        placeholder="Paste video URL here..."
      />
      <button id="previousButton" title="Previous video">Previous</button>
      <button id="loadButton" title="Load video">Load</button>
    </div>

    <video id="videoPlayer" controls></video>

    <a
      id="grafana-link"
      href="https://eyevinn-openanalytics.grafana-grafana.auto.prod.osaas.io/d/aekgm1nvquozkd/counting-events?orgId=1&from=now-6h&to=now&timezone=browser"
      target="_blank"
      rel="noopener noreferrer"
      tabindex="0"
      role="button"
    >
      Open Grafana Dashboard
    </a>
  </div>

  <footer>
    <a
      id="osc-link"
      href="https://docs.osaas.io/osaas.wiki/Solution%3A-Eyevinn-Open-Analytics.html"
      target="_blank"
      rel="noopener noreferrer"
      tabindex="2"
    >Getting Started</a>
    <a
      id="osc-logo"
      href="https://www.osaas.io/"
      target="_blank"
      rel="noopener noreferrer"
      tabindex="1"
    >
      <picture>
        <source srcset="./OSC-logo-darkmode.png" media="(prefers-color-scheme: dark)">
        <img src="./OSC-logo-lightmode.png" />
      </picture>
    </a>
  </footer>

  <script type="module">
    document.addEventListener("DOMContentLoaded", () => {
      const videoElement = document.getElementById("videoPlayer");
      const inputElement = document.getElementById("videoUrlInput");
      const loadBtn = document.getElementById("loadButton");
      const prevBtn = document.getElementById("previousButton");

      const historyStack = [];

      function cleanUrl(raw) {
        let url = raw.trim().replace(/^"|"$/g, "");
        if (url.includes(" ")) {
          url = url.split(" ")[0];
        }
        return url;
      }

      function loadVideo(urlRaw, addToHistory = true) {
        const url = cleanUrl(urlRaw);
        if (!url) return;

        if (addToHistory && videoElement.src) {
          historyStack.push(videoElement.src);
        }

        if (Hls.isSupported() && url.endsWith(".m3u8")) {
          const hls = new Hls();
          hls.loadSource(url);
          hls.attachMedia(videoElement);
        } else {
          videoElement.src = url;
        }

        videoElement.play();
      }

      loadBtn.addEventListener("click", () => {
        const url = inputElement.value;
        loadVideo(url);
      });

      inputElement.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          loadBtn.click();
        }
      });

      prevBtn.addEventListener("click", () => {
        const prevUrl = historyStack.pop();
        if (prevUrl) {
          loadVideo(prevUrl, false);
        } else {
          alert("No previous video in history.");
        }
      });

      // Default video
      loadVideo("https://archive.org/serve/big-bunny-sample-video/SampleVideo.ia.mp4", false);

      // Accessibility for Grafana
      document.getElementById("grafana-link").addEventListener("keydown", function (e) {
        if (e.key === "Enter" || e.key === " ") {
          window.open(this.href, "_blank", "noopener");
        }
      });
    });
  </script>
</body>
</html>